<div class="container">
  <div class="profile-card" *ngFor="let profile of studentProfiles">
    <h2 class="profile-heading">Student Profile View</h2>

    <!-- Student Profile Card -->
    <mat-card class="mat-elevation-z4">
      <mat-card-content class="profile-container">

        <!-- Left Side: Student Photo -->
  <div class="profile-photo">
  <img [src]="selectedStudentProfile?.photoUrl || defaultImage" 
       alt="Profile" 
       class="profile-avatar" />
</div>


        <!-- Right Side: Basic Info -->
        <div class="profile-info" *ngIf="profile.trialStudentId as trialId">
          <h1 class="name">
             <b>{{ trialStudents[trialId]?.firstName | uppercase }} {{ trialStudents[trialId]?.lastName | uppercase }}</b>

          </h1>
          <p><strong>Reference ID : </strong><b style="color: rgb(87, 87, 223);">{{ profile?.studentReferenceId }}</b>
          </p>
          <p><strong>Email:</strong> {{ trialStudents[trialId]?.email }}</p>
          <p><strong>Phone:</strong> {{ trialStudents[trialId]?.phone }}</p>
          <p><strong>Address:</strong> {{ trialStudents[trialId]?.address }}</p>
          <p><strong>Date of Birth:</strong> {{ profile?.dob | date:'dd/MM/yyyy' }}</p>

          <!-- Referred By (Dropdown) -->
          <p><strong>Referred By:</strong> {{ getReferenceText(profile.referredBy) }}</p>

          <!-- Student Status -->
           <p><strong>Status:</strong> {{ (profile.currentstatus) }}</p>

            <!-- <p><b>DEBUG STATUS:</b> {{ profile.Currentstatus }}</p>
<p><b>DEBUG TEXT:</b> {{ getCurrentStatusText(profile.Currentstatus) }}</p>
<p><b>DEBUG COMPANY:</b> {{ profile.companyName }}</p> -->


          <!-- Placed company (ONLY if status == Placed) -->
           <!-- <div *ngIf="Number(profile.currentstatus) === 4"> -->

<div *ngIf="getCurrentStatusValue(profile.currentstatus) === 4">
  <strong>Placed Company:</strong><span *ngIf="profile.companyNames?.length">
  {{ profile.companyNames?.join(', ') }}
</span>

</div>





        </div>

      </mat-card-content>

      <mat-card-actions class="profile-actions">
        <button mat-icon-button color="primary" (click)="openEditProfileDialog(profile)">
          <mat-icon>edit</mat-icon>
        </button>
        <button mat-icon-button color="warn" (click)="openDeleteProfileDialog(profile.studentId!)">
          <mat-icon>delete</mat-icon>
        </button>
      </mat-card-actions>
    </mat-card>


    <!-- secondarycontact -->
    <mat-card class="secondary-contact-card mat-elevation-z4">
  <mat-card-content>
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 class="mb-0">Secondary Contact</h3>
      <button
        *ngIf="!isEditingSecondaryContact"
        mat-mini-fab
        color="accent"
        (click)="enableSecondaryContactEdit()"
        matTooltip="{{ secondaryContact ? 'Edit Secondary Contact' : 'Add Secondary Contact' }}"
      >
        <mat-icon>{{ secondaryContact ? 'edit' : 'add' }}</mat-icon>
      </button>
    </div>

    <!-- ðŸ§¾ Display existing contact -->
    <div *ngIf="!isEditingSecondaryContact && secondaryContact; else editFormOrNoData">
      <table mat-table [dataSource]="[secondaryContact]" class="mat-elevation-z2 w-100">
        <ng-container matColumnDef="guardianName">
          <th mat-header-cell *matHeaderCellDef>Guardian Name</th>
          <td mat-cell *matCellDef="let item">{{ item.guardianName || 'N/A' }}</td>
        </ng-container>
        <ng-container matColumnDef="relation">
          <th mat-header-cell *matHeaderCellDef>Relation</th>
          <td mat-cell *matCellDef="let item">{{ item.relation || 'N/A' }}</td>
        </ng-container>
        <ng-container matColumnDef="phone">
          <th mat-header-cell *matHeaderCellDef>Phone</th>
          <td mat-cell *matCellDef="let item">{{ item.phone || 'N/A' }}</td>
        </ng-container>
        <ng-container matColumnDef="address">
          <th mat-header-cell *matHeaderCellDef>Address</th>
          <td mat-cell *matCellDef="let item">{{ item.adress || 'N/A' }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['guardianName', 'relation', 'phone', 'address']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['guardianName', 'relation', 'phone', 'address'];"></tr>
      </table>
    </div>

    <!-- âœï¸ Edit/Add form -->
    <ng-template #editFormOrNoData>
      <form [formGroup]="secondaryContactForm" *ngIf="isEditingSecondaryContact" (ngSubmit)="saveSecondaryContact()">
        <mat-form-field class="w-100">
          <mat-label>Guardian Name</mat-label>
          <input matInput formControlName="guardianName" />
        </mat-form-field>

        <mat-form-field class="w-100">
          <mat-label>Relation</mat-label>
          <input matInput formControlName="relation" />
        </mat-form-field>

        <mat-form-field class="w-100">
          <mat-label>Phone</mat-label>
          <input matInput formControlName="phone" maxlength="10" />
        </mat-form-field>

        <mat-form-field class="w-100">
          <mat-label>Address</mat-label>
          <textarea matInput formControlName="adress"></textarea>
        </mat-form-field>

        <div class="d-flex justify-content-end gap-2 mt-3">
          <button mat-stroked-button type="button" (click)="cancelSecondaryContactEdit()">Cancel</button>
          <button mat-flat-button color="primary" type="submit" [disabled]="secondaryContactForm.invalid">Save</button>
        </div>
      </form>

      <div *ngIf="!secondaryContact && !isEditingSecondaryContact" class="text-center mt-3">
        <p>No secondary contact found.</p>
        <button mat-raised-button color="accent" (click)="enableSecondaryContactEdit()">
          <mat-icon class="me-1">add</mat-icon> Add Secondary Contact
        </button>
      </div>
    </ng-template>
  </mat-card-content>
</mat-card>


    <!-- Course Details -->
    <mat-card class="course-card mat-elevation-z4" *ngIf="profile.studentId; else noCourseDetails">
      <mat-card-content>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h3 class="mb-0">Course Details</h3>
          <button mat-mini-fab color="accent" (click)="openAddCourseDialog(profile.studentId!)" matTooltip="Add Course">
            <mat-icon>add</mat-icon>
          </button>
        </div>
        <ng-container *ngIf="courseDataLoaded && courseDetails[profile.studentId!] as detail">
          <table mat-table [dataSource]="detail" class="mat-elevation-z2">
            <!-- Course Name Column -->
            <ng-container matColumnDef="courseName">
              <th mat-header-cell *matHeaderCellDef>Course</th>
              <td mat-cell *matCellDef="let item">{{ courses[item.courseId] || 'N/A' }}</td>
            </ng-container>

            <!-- Batch Column -->
            <ng-container matColumnDef="batch">
              <th mat-header-cell *matHeaderCellDef>Batch</th>
              <td mat-cell *matCellDef="let item">{{ batches[item.batchId] || 'N/A' }}</td>
            </ng-container>

            <!-- Time Slot Column -->
            <ng-container matColumnDef="timeSlot">
              <th mat-header-cell *matHeaderCellDef>Time Slot</th>
              <td mat-cell *matCellDef="let item">{{ item.timeSlot || 'N/A' }}</td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let item">{{ getStatusText(item.status) }}</td>
            </ng-container>

            <!-- Mode Column -->
            <ng-container matColumnDef="mode">
              <th mat-header-cell *matHeaderCellDef>Mode</th>
              <td mat-cell *matCellDef="let item">{{ getModeText(item.mode) }}</td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let item">
                <button mat-icon-button color="primary" (click)="openEditCourseDetailsDialog(item)">
                  <mat-icon>edit</mat-icon>
                </button>

              </td>
            </ng-container>

            <!-- Table Headers & Rows -->
            <tr mat-header-row *matHeaderRowDef="['courseName', 'batch', 'timeSlot', 'status', 'mode', 'actions']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['courseName', 'batch', 'timeSlot', 'status', 'mode', 'actions']">
            </tr>
          </table>
        </ng-container>
      </mat-card-content>
    </mat-card>
    <ng-template #noCourseDetails>
      <mat-card class="course-card mat-elevation-z4">
        <mat-card-content>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h3 class="mb-0">Course Details</h3>
          </div>
          <p>No course details found.</p>
        </mat-card-content>
      </mat-card>
    </ng-template>
    <mat-card class="qualification-card mat-elevation-z4"
      *ngIf="qualifications[profile.studentId!]?.length; else noQualifications">
      <mat-card-content>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h3 class="mb-0">Qualifications</h3>
          <button mat-mini-fab color="accent" (click)="openAddQualificationDialog(profile.studentId!)"
            matTooltip="Add Qualification">
            <mat-icon>add</mat-icon>
          </button>
        </div>
        <table mat-table [dataSource]="qualifications[profile.studentId!]" class="mat-elevation-z2">
          <!-- Qualification Name Column -->
          <ng-container matColumnDef="qualificationName">
            <th mat-header-cell *matHeaderCellDef>Qualification</th>
            <td mat-cell *matCellDef="let q">{{ q.qualificationName || 'N/A' }}</td>
          </ng-container>

          <!-- College Name Column -->
          <ng-container matColumnDef="collegeName">
            <th mat-header-cell *matHeaderCellDef>College Name</th>
            <td mat-cell *matCellDef="let q">{{ q.collegeName || 'N/A' }}</td>
          </ng-container>

          <!-- Pass-out Year Column -->
          <ng-container matColumnDef="passOutYear">
            <th mat-header-cell *matHeaderCellDef>Passout Year</th>
            <td mat-cell *matCellDef="let q">{{ q.passOutYear || 'N/A' }}</td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let q">

              <button mat-icon-button color="primary" (click)="openEditQualificationDialog(q)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="openDeleteQualificationDialog(q.qualificationId)">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <!-- Table Rows -->
          <tr mat-header-row *matHeaderRowDef="['qualificationName', 'collegeName', 'passOutYear', 'actions']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['qualificationName', 'collegeName', 'passOutYear', 'actions']">
          </tr>
        </table>
      </mat-card-content>
    </mat-card>
    <ng-template #noQualifications>
      <mat-card class="qualification-card mat-elevation-z4">
        <mat-card-content>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h3 class="mb-0">Qualifications</h3>
            <button mat-mini-fab color="accent" (click)="openAddQualificationDialog(profile.studentId!)"
              matTooltip="Add Qualification">
              <mat-icon>add</mat-icon>
            </button>
          </div>
          <p>No qualifications found.</p>
        </mat-card-content>
      </mat-card>
    </ng-template>


    <!-- Experience Section -->
    <mat-card class="experience-card mat-elevation-z4"
      *ngIf="profile.studentId && (experiences[profile.studentId] || []).length > 0; else noExperiences">
      <mat-card-content>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h3 class="mb-0">Experience</h3>
          <button mat-mini-fab color="accent" (click)="openAddExperienceDialog(profile.studentId)"
            matTooltip="Add Experience">
            <mat-icon>add</mat-icon>
          </button>
        </div>
        <table mat-table [dataSource]="experiences[profile.studentId] || []" class="mat-elevation-z2">
          <!-- Position -->
          <ng-container matColumnDef="position">
            <th mat-header-cell *matHeaderCellDef>Position</th>
            <td mat-cell *matCellDef="let exp">{{ exp.position || 'N/A' }}</td>
          </ng-container>

          <!-- Company Name -->
          <ng-container matColumnDef="companyName">
            <th mat-header-cell *matHeaderCellDef>Company</th>
            <td mat-cell *matCellDef="let exp">{{ exp.companyName || 'N/A' }}</td>
          </ng-container>

          <!-- Total Experience -->
          <ng-container matColumnDef="totalExperience">
            <th mat-header-cell *matHeaderCellDef>Years</th>
            <td mat-cell *matCellDef="let exp">{{ exp.totalExperience || 'N/A' }}</td>
          </ng-container>

          <!-- Actions -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let exp">
              <button mat-icon-button color="primary" (click)="openEditExperienceDialog(exp)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn"
                (click)="openDeleteExperienceDialog(exp.experienceId, profile.studentId)">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['position', 'companyName', 'totalExperience', 'actions']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['position', 'companyName', 'totalExperience', 'actions']"></tr>
        </table>
      </mat-card-content>
    </mat-card>
    <ng-template #noExperiences>
      <!-- Empty template to hide the section when no experiences exist -->
    </ng-template>
    <!-- Fee Details -->
    <mat-card class="qualification-card mat-elevation-z4">
      <mat-card-content>
        <div *ngFor="let course of feesByCourse" class="mb-6">
          <h2 mat-subheader>{{ course.courseName }}</h2>

          <table mat-table [dataSource]="course.fees" class="mat-elevation-z2 full-width-table">

            <!-- Installment Number -->
            <ng-container matColumnDef="installmentNumber">
              <th mat-header-cell *matHeaderCellDef> Installment # </th>
              <td mat-cell *matCellDef="let fee"> {{ fee.installmentNumber }} </td>
            </ng-container>

            <!-- Due Date -->
            <ng-container matColumnDef="dueDate">
              <th mat-header-cell *matHeaderCellDef> Due Date </th>
              <td mat-cell *matCellDef="let fee"> {{ fee.dueDate | date:'dd-MMM-yyyy' }} </td>
            </ng-container>

            <!-- Amount -->
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef> Amount </th>
              <td mat-cell *matCellDef="let fee"> {{ fee.amount }} </td>
            </ng-container>

            <!-- Amount Received -->
            <ng-container matColumnDef="amountReceived">
              <th mat-header-cell *matHeaderCellDef> Received </th>
              <td mat-cell *matCellDef="let fee"> {{ fee.amountReceived || 0 }} </td>
            </ng-container>

            <!-- Due Amount -->
            <ng-container matColumnDef="dueAmount">
              <th mat-header-cell *matHeaderCellDef> Due </th>
              <td mat-cell *matCellDef="let fee"> {{ fee.dueAmount }} </td>
            </ng-container>

            <!-- Status -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let fee">
                <span [ngClass]="getStatusClass(fee.status)">
                  {{ fee.status }}
                </span>
              </td>
            </ng-container>

            <!-- Header & Rows -->
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div><br>
      </mat-card-content>
    </mat-card>
  </div>  


</div>